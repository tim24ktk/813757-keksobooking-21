(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),o=document.querySelector(".ad-form"),n=t.children,r=o.children,i=o.querySelector("#address"),a=document.querySelector(".map__pin--main"),d=a.offsetLeft,s=a.offsetTop,c=Math.round(d+32.5),m=Math.round(s+32.5),l={x:Math.round(d+32.5),y:Math.round(s+80)},u=()=>{e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),window.map.createPins();for(const e of n)e.disabled=!1;for(const e of r)e.disabled=!1;window.form.renderAddress(l.x,l.y),window.form.submitButton.style.pointerEvents="auto",a.removeEventListener("mousedown",w),a.removeEventListener("keydown",p)},p=e=>{h(e,u)},w=e=>{_(e,u)},f=()=>{a.addEventListener("keydown",p),a.addEventListener("mousedown",w)};f();const v=()=>{for(const e of n)e.disabled=!0};v();const y=()=>{for(const e of r)e.disabled=!0;i.value=`${c}, ${m}`};y();const h=(e,t)=>{"Enter"===e.key&&t()},_=(e,t)=>{0===e.button&&t()};window.main={map:e,adForm:o,mapFilters:t,checkEscape:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},checkMouseDown:_,mapPin:a,address:i,pinWidth:65,pinHeightActive:80,blockFilters:v,blockFilling:y,addEvent:f,pinAddressX:l.x,pinAddressY:l.y}})(),window.backend={handleRequest:(e,t,o,n,r)=>{const i=new XMLHttpRequest;return i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case 200:o(i.response);break;case 400:e="Неверный запрос";break;case 404:e="Ничего не найдено";break;case 500:e="Внутренняя ошибка сервера";break;case 503:e="Сервис недоступен";break;default:e=`Cтатус ответа: : ${i.status} ${i.statusText}`}e&&n(e)})),i.addEventListener("error",(()=>{n("Произошла ошибка соединения с сервером")})),i.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.timeout=1e4,i.open(e,t),"GET"===e?i.send():i.send(r)}},(()=>{const e="GET";window.download=(t,o)=>{window.backend.handleRequest(e,"https://21.javascript.pages.academy/keksobooking/data",t,o)}})(),(()=>{const e="any",t=window.main.mapFilters.querySelector("#housing-type"),o=window.main.mapFilters.querySelector("#housing-price"),n=window.main.mapFilters.querySelector("#housing-rooms"),r=window.main.mapFilters.querySelector("#housing-guests");let i=[];const a=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},d=()=>{const e=document.querySelector(".map__card");e&&(e.remove(),window.pins.removeActive())},s=(e,t)=>t.every((t=>e.offer.features.includes(t))),c=i=>(o=>t.value===e||t.value===o.offer.type)(i)&&(e=>{switch(o.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>=5e4}return!0})(i)&&(t=>n.value===e||+n.value===t.offer.rooms)(i)&&(t=>r.value===e||+r.value===t.offer.guests)(i),m=()=>{const e=[],t=window.main.mapFilters.querySelectorAll("input:checked"),o=[];t.forEach((e=>{o.push(e.value)}));for(let t=0;t<i.length;t++){const n=i[t];if(c(n)&&s(n,o)&&(e.push(n),5===e.length))break}window.pins.createElements(e)};window.main.mapFilters.addEventListener("change",(e=>{e.preventDefault(),window.debounce((()=>{a(),d(),m()}))}));const l=e=>{i=e,m()},u=e=>{window.message.showError(e),window.main.blockFilters()};window.map={createPins:()=>{window.download(l,u)},removeCard:d,removePins:a,updatePins:m}})(),(()=>{const e=window.main.adForm.querySelector(".ad-form__element--time"),t=window.main.adForm.querySelector("#price"),o=e.querySelector("#timein"),n=e.querySelector("#timeout"),r=window.main.adForm.querySelector("#room_number"),i=window.main.adForm.querySelector("#capacity"),a=document.querySelector("#type"),d=window.main.adForm.querySelector(".ad-form__submit");e.addEventListener("change",(e=>{o.value=e.target.value,n.value=e.target.value}));const s={bungalow:0,flat:1e3,house:5e3,palace:1e4},c=()=>{const e=s[a.value];t.placeholder=e,t.min=e};a.addEventListener("change",(()=>{c()})),i.addEventListener("change",(()=>{m()})),r.addEventListener("change",(()=>{m()}));const m=()=>{const e=(()=>{const e=+i.value,t=+r.value;return e<=t&&100!==t&&0!==e||100===t&&0===e})()?"":"Недоступное кол. мест";i.setCustomValidity(e);const t=""!==e?"red":"";r.style.borderColor=t,i.style.borderColor=t},l=document.querySelector("#success").content.querySelector(".success"),u=document.querySelector("main"),p=document.querySelector("#error").content.querySelector(".error"),w=()=>{const e=document.querySelector(".success, .error");null!==e&&(e.remove(),y())},f=()=>{w()},v=()=>{document.addEventListener("keydown",h),document.addEventListener("click",_)},y=()=>{document.removeEventListener("keydown",h),document.removeEventListener("click",_)},h=e=>{window.main.checkEscape(e,w)},_=e=>{window.main.checkMouseDown(e,w)},q=()=>{window.main.adForm.reset(),c(),m(),window.main.mapFilters.reset(),window.main.map.classList.add("map--faded"),window.main.adForm.classList.add("ad-form--disabled"),window.uploadPhoto.reset(),window.main.blockFilters(),window.main.blockFilling(),window.map.removePins(),window.map.removeCard(),window.main.mapPin.style.left="570px",window.main.mapPin.style.top="375px",window.main.addEvent(),d.style.pointerEvents="none"},E=()=>{q(),(()=>{const e=l.cloneNode(!0);u.appendChild(e)})(),v()},S=()=>{(()=>{const e=p.cloneNode(!0);u.appendChild(e),e.querySelector(".error__button").addEventListener("click",f)})(),v()};document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),q()})),window.main.adForm.addEventListener("submit",(e=>{e.preventDefault(),window.upload(new FormData(window.main.adForm),E,S)})),window.form={renderAddress:(e,t)=>{window.main.address.value=`${e}, ${t}`},submitButton:d}})(),(()=>{const e="POST";window.upload=(t,o,n)=>{window.backend.handleRequest(e,"https://21.javascript.pages.academy/keksobooking",o,n,t)}})(),(()=>{const e=window.main.map.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=()=>{const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active")},n=e=>{const n=t.cloneNode(!0),r=n.querySelector("img");return n.style.left=e.location.x-25+"px",n.style.top=e.location.y-70+"px",r.src=e.author.avatar,r.alt=e.offer.title,n.addEventListener("click",(()=>{window.map.removeCard(),o(),n.classList.add("map__pin--active"),window.card.create(e)})),n};window.pins={createElements:t=>{const o=t.length>5?5:t.length,r=document.createDocumentFragment();for(let e=0;e<o;e++)void 0!==t[e].offer&&r.appendChild(n(t[e]));e.appendChild(r)},removeActive:o}})(),(()=>{const e=e=>{switch(e){case"palace":return"Дворец";case"flat":return"Квартира";case"house":return"Дом";case"bungalow":return"Бунгало"}return e},t=document.querySelector("#card").content.querySelector(".popup"),o=document.querySelector(".map__filters-container"),n=document.querySelector(".map"),r=()=>{window.map.removeCard(),document.removeEventListener("keydown",i)},i=e=>{window.main.checkEscape(e,r)},a=e=>{window.main.checkMouseDown(e,r)};window.card={create:r=>{const d=document.createDocumentFragment();d.appendChild((o=>{const n=t.cloneNode(!0),r=n.querySelector(".popup__text--price"),d=n.querySelector(".popup__avatar"),s=n.querySelector(".popup__title"),c=n.querySelector(".popup__text--address"),m=n.querySelector(".popup__type"),l=n.querySelector(".popup__text--capacity"),u=n.querySelector(".popup__text--time"),p=n.querySelector(".popup__description");void 0!==o.offer.price?r.textContent=o.offer.price+"₽/ночь":r.remove(),void 0!==o.author.avatar?d.src=o.author.avatar:d.remove(),void 0!==o.offer.title?s.textContent=o.offer.title:s.remove(),void 0!==o.offer.address?c.textContent=o.offer.address:c.remove(),void 0!==e(o.offer.type)?m.textContent=e(o.offer.type):m.remove(),void 0!==o.offer.rooms&&void 0!==o.offer.guests?l.textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`:l.remove(),void 0!==o.offer.checkin&&void 0!==o.offer.checkout?u.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`:u.remove(),void 0!==o.offer.description?p.textContent=o.offer.description:p.remove();const w=n.querySelector(".popup__features");if(w.innerHTML="",void 0!==o.offer.features){const e=document.createDocumentFragment();o.offer.features.forEach((t=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+t,e.appendChild(o)})),w.appendChild(e)}const f=n.querySelector(".popup__photos"),v=n.querySelector(".popup__photo");void 0!==o.offer.photos&&o.offer.photos.forEach((e=>{const t=v.cloneNode(!0);t.src=e,f.appendChild(t)})),f.removeChild(v);const y=n.querySelector(".popup__close");return document.addEventListener("keydown",i),y.addEventListener("click",a),n})(r)),n.insertBefore(d,o)}}})(),(()=>{const e=document.querySelector(".map__pins");window.main.mapPin.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=e=>{e.preventDefault();const t=o.x-e.clientX,n=o.y-e.clientY;o={x:e.clientX,y:e.clientY};const r=window.main.mapPin.offsetLeft-t,i=window.main.mapPin.offsetTop-n;r>=-window.main.pinWidth/2&&r<=window.main.map.clientWidth-window.main.pinWidth/2+1&&i>=130-window.main.pinHeightActive&&i<=630-window.main.pinHeightActive&&(window.main.mapPin.style.left=r+"px",window.main.mapPin.style.top=i+"px",window.form.renderAddress(r+Math.floor(window.main.pinWidth/2),i+window.main.pinHeightActive))},r=t=>{t.preventDefault(),e.removeEventListener("mousemove",n),e.removeEventListener("mouseup",r)};e.addEventListener("mousemove",n),e.addEventListener("mouseup",r),e.addEventListener("mouseleave",(()=>{e.removeEventListener("mousemove",n),e.removeEventListener("mouseup",r)}))}))})(),(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),window.message={showError:e=>{const t=document.createElement("div"),o=t.style;t.textContent=e,o.width="400px",o.height="60px",o.borderWidth="5px",o.borderStyle="solid",o.borderRadius="20px",o.font="25px",o.color="red",o.backgroundColor="white",o.position="fixed",o.zIndex="1000",o.display="flex",o.justifyContent="space-around",o.alignItems="center",o.top="50%",o.left="50%",o.transform="translateX(-200px)",document.body.appendChild(t),window.setTimeout((()=>t.remove()),500)}},(()=>{const e=["gif","jpg","jpeg","png"],t=window.main.adForm.querySelector(".ad-form-header__input"),o=window.main.adForm.querySelector(".ad-form-header__preview img"),n=window.main.adForm.querySelector(".ad-form__input"),r=window.main.adForm.querySelector(".ad-form__photo"),i=i=>{const a=i.target,d=a.files[0],s=d.name.toLowerCase();if(e.some((e=>s.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{switch(a){case t:o.src=e.result;break;case n:const i=document.createElement("img");i.src=e.result,i.style.maxWidth="70px",i.style.maxHeight="70px",r.appendChild(i)}})),e.readAsDataURL(d)}};t.addEventListener("change",(e=>{i(e)})),n.addEventListener("change",(e=>{i(e)})),window.uploadPhoto={reset:()=>{o.src="img/muffin-grey.svg",r.innerHTML=""}}})()})();